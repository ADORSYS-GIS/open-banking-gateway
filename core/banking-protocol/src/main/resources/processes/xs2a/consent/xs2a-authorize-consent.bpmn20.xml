<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:flowable="http://flowable.org/bpmn" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" typeLanguage="http://www.w3.org/2001/XMLSchema" expressionLanguage="http://www.w3.org/1999/XPath" targetNamespace="http://www.flowable.org/processdef">
  <process id="xs2a-authorize-consent" name="xs2a-authorize-consent" isExecutable="true">
    <documentation>XS2A consent authorization process</documentation>
    <startEvent id="start" name="start" flowable:formFieldValidation="true"></startEvent>
    <serviceTask id="startAuthorization" name="Start SCA authorization" flowable:async="true" flowable:delegateExpression="${xs2aStartAuthorization}"></serviceTask>
    <serviceTask id="scaEmbeddedChallenge" name="Perform SCA embedded challenge" flowable:async="true" flowable:delegateExpression="${xs2aDoScaChallenge}"></serviceTask>
    <serviceTask id="finalizeEmbeddedAuthoration" name="Finalize embedded authoration" flowable:async="true" flowable:delegateExpression="${xs2aFinalizeConsent}"></serviceTask>
    <endEvent id="end" name="end"></endEvent>
    <sequenceFlow id="sid-1139B3D0-261B-4594-B84F-638928669262" sourceRef="start" targetRef="startAuthorization"></sequenceFlow>
    <sequenceFlow id="sid-3E4021E2-4726-4056-97A0-A40CABFCEDBA" sourceRef="scaEmbeddedChallenge" targetRef="finalizeEmbeddedAuthoration"></sequenceFlow>
    <exclusiveGateway id="scaChallengeSelector">
      <documentation>Determines which SCA method was selected by bank</documentation>
    </exclusiveGateway>
    <sequenceFlow id="sid-D15341DB-F89B-491F-9F3D-FFA8D98F770F" sourceRef="startAuthorization" targetRef="scaChallengeSelector"></sequenceFlow>
    <serviceTask id="notifyUserWithRedirect" name="Notify user with redirect url for challenge" flowable:async="true" flowable:delegateExpression="${xs2aDoRedirectForScaChallenge}"></serviceTask>
    <sequenceFlow id="embedded" name="embedded" sourceRef="scaChallengeSelector" targetRef="scaEmbeddedChallenge">
      <documentation>ASPSP selected embedded SCA</documentation>
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[#{xs2aAspspMethodGateway.isEmbedded(CONTEXT)}]]></conditionExpression>
    </sequenceFlow>
    <serviceTask id="finalizeRedirectAuthoration" name="Finalize redirect authoration" flowable:async="true" flowable:delegateExpression="${xs2aFinalizeConsent}"></serviceTask>
    <sequenceFlow id="sid-1DFDC2B8-6141-4818-99C6-89D8BDB7E871" sourceRef="finalizeEmbeddedAuthoration" targetRef="end"></sequenceFlow>
    <sequenceFlow id="sid-AE14268E-834A-482F-ABF7-D4B63933E136" sourceRef="finalizeRedirectAuthoration" targetRef="end"></sequenceFlow>
    <sequenceFlow id="redirect" name="redirect" sourceRef="scaChallengeSelector" targetRef="notifyUserWithRedirect">
      <conditionExpression xsi:type="tFormalExpression"><![CDATA[#{xs2aAspspMethodGateway.isRedirect(CONTEXT)}]]></conditionExpression>
    </sequenceFlow>
    <receiveTask id="waitForUserScaComplete" name="Waits for user to complete SCA" flowable:async="true"></receiveTask>
    <sequenceFlow id="sid-6AAE53C3-DAA6-455D-A7A2-E35086D95D45" sourceRef="notifyUserWithRedirect" targetRef="waitForUserScaComplete"></sequenceFlow>
    <sequenceFlow id="sid-FC171C5B-4D7E-40B5-9C35-31DF93146BB6" sourceRef="waitForUserScaComplete" targetRef="finalizeRedirectAuthoration"></sequenceFlow>
  </process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_xs2a-authorize-consent">
    <bpmndi:BPMNPlane bpmnElement="xs2a-authorize-consent" id="BPMNPlane_xs2a-authorize-consent">
      <bpmndi:BPMNShape bpmnElement="start" id="BPMNShape_start">
        <omgdc:Bounds height="30.0" width="30.0" x="100.0" y="263.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="startAuthorization" id="BPMNShape_startAuthorization">
        <omgdc:Bounds height="80.0" width="100.0" x="195.0" y="240.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="scaEmbeddedChallenge" id="BPMNShape_scaEmbeddedChallenge">
        <omgdc:Bounds height="80.0" width="100.0" x="420.0" y="105.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="finalizeEmbeddedAuthoration" id="BPMNShape_finalizeEmbeddedAuthoration">
        <omgdc:Bounds height="80.0" width="100.0" x="705.0" y="105.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="end" id="BPMNShape_end">
        <omgdc:Bounds height="28.0" width="28.0" x="855.0" y="266.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="scaChallengeSelector" id="BPMNShape_scaChallengeSelector">
        <omgdc:Bounds height="40.0" width="40.0" x="345.0" y="258.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="notifyUserWithRedirect" id="BPMNShape_notifyUserWithRedirect">
        <omgdc:Bounds height="80.0" width="100.0" x="420.0" y="375.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="finalizeRedirectAuthoration" id="BPMNShape_finalizeRedirectAuthoration">
        <omgdc:Bounds height="80.0" width="100.0" x="720.0" y="375.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape bpmnElement="waitForUserScaComplete" id="BPMNShape_waitForUserScaComplete">
        <omgdc:Bounds height="80.0" width="100.0" x="570.0" y="375.0"></omgdc:Bounds>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge bpmnElement="sid-1139B3D0-261B-4594-B84F-638928669262" id="BPMNEdge_sid-1139B3D0-261B-4594-B84F-638928669262">
        <omgdi:waypoint x="129.94818070118578" y="278.2299735565482"></omgdi:waypoint>
        <omgdi:waypoint x="194.99999999999716" y="279.2307692307692"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="redirect" id="BPMNEdge_redirect">
        <omgdi:waypoint x="365.0" y="297.9427242888402"></omgdi:waypoint>
        <omgdi:waypoint x="365.0" y="415.0"></omgdi:waypoint>
        <omgdi:waypoint x="420.0" y="415.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="sid-1DFDC2B8-6141-4818-99C6-89D8BDB7E871" id="BPMNEdge_sid-1DFDC2B8-6141-4818-99C6-89D8BDB7E871">
        <omgdi:waypoint x="804.949999999996" y="145.0"></omgdi:waypoint>
        <omgdi:waypoint x="869.0" y="145.0"></omgdi:waypoint>
        <omgdi:waypoint x="869.0" y="266.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="sid-D15341DB-F89B-491F-9F3D-FFA8D98F770F" id="BPMNEdge_sid-D15341DB-F89B-491F-9F3D-FFA8D98F770F">
        <omgdi:waypoint x="294.9499999999989" y="279.1666666666667"></omgdi:waypoint>
        <omgdi:waypoint x="345.327868852459" y="278.32704918032783"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="sid-AE14268E-834A-482F-ABF7-D4B63933E136" id="BPMNEdge_sid-AE14268E-834A-482F-ABF7-D4B63933E136">
        <omgdi:waypoint x="819.949999999937" y="415.0"></omgdi:waypoint>
        <omgdi:waypoint x="869.0" y="415.0"></omgdi:waypoint>
        <omgdi:waypoint x="869.0" y="293.94992943204846"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="sid-FC171C5B-4D7E-40B5-9C35-31DF93146BB6" id="BPMNEdge_sid-FC171C5B-4D7E-40B5-9C35-31DF93146BB6">
        <omgdi:waypoint x="669.9499999999999" y="415.0"></omgdi:waypoint>
        <omgdi:waypoint x="719.9999999999363" y="415.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="sid-6AAE53C3-DAA6-455D-A7A2-E35086D95D45" id="BPMNEdge_sid-6AAE53C3-DAA6-455D-A7A2-E35086D95D45">
        <omgdi:waypoint x="519.95" y="415.0"></omgdi:waypoint>
        <omgdi:waypoint x="569.9999999999363" y="415.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="sid-3E4021E2-4726-4056-97A0-A40CABFCEDBA" id="BPMNEdge_sid-3E4021E2-4726-4056-97A0-A40CABFCEDBA">
        <omgdi:waypoint x="519.9499999998878" y="145.0"></omgdi:waypoint>
        <omgdi:waypoint x="705.0" y="145.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge bpmnElement="embedded" id="BPMNEdge_embedded">
        <omgdi:waypoint x="365.0" y="258.0"></omgdi:waypoint>
        <omgdi:waypoint x="365.0" y="145.0"></omgdi:waypoint>
        <omgdi:waypoint x="420.0" y="145.0"></omgdi:waypoint>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
