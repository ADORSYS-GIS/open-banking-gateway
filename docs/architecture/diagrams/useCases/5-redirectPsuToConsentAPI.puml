@startuml
title PsuAuthorizeEmbeddedConsent
autonumber 10 10 "<b><color blue>[InitConsent-000]</color></b>"
actor psu

box "PsuUserAgent" #LightGray
    participant "FinTechUI" as FinTechUI
    participant "ConsentAuthorisationUI" as ConsentAuthorisationUI
    'participant "OnlineBankingUI" as OnlineBankingUI
end box
box "FinTechDC" #DarkSeaGreen
    participant "FinTechApi" as FinTechApi
end box
box "TppDC" #LightGray
    'participant "TppBankingApi" as TppBankingApi
    'participant "TppBankSearchApi" as TppBankSearchApi
    participant "ConsentAuthorisationApi" as ConsentAuthorisationApi
    participant "BankingProtocolFacade" as BankingProtocolFacade

    participant "BankingProtocol" as BankingProtocol
    'participant "RedirectSessionStoreApi" as RedirectSessionStoreApi
end box
box "AspspDC" #LightSkyBlue
	participant "AspspBankingApi" as AspspBankingApi
    participant "OnlineBankingApi" as OnlineBankingApi
end box

FinTechUI -> ConsentAuthorisationApi ++ : GET:ConsentAuthorisationApi.auth[UserAgentContext]()<redirectCode>
ConsentAuthorisationApi -> BankingProtocolFacade ++ : redirectSession(redirectCode)
deactivate ConsentAuthorisationApi
BankingProtocolFacade -> BankingProtocolFacade : selectBankingProtocol(redirectCode):BankingProtocol
BankingProtocolFacade -> BankingProtocol ++ : redirectSession(redirectCode)
BankingProtocol -> BankingProtocol : loadAuthSession(redirectCode)
deactivate BankingProtocolFacade
deactivate BankingProtocol
alt PreAuthentication.embedded
    BankingProtocol --> BankingProtocolFacade ++ : ThrowIdentifyPSU
    BankingProtocolFacade --> ConsentAuthorisationApi ++ : ThrowIdentifyPSU
    deactivate BankingProtocolFacade
    ConsentAuthorisationApi -> ConsentAuthorisationApi : getCookie(state):\nSessionCookie
    ConsentAuthorisationApi --> ConsentAuthorisationUI ++ : redirect302[SessionCookie,\nConsentAuthorisationUI.embeddedAuthInitScreen]()<state>
    deactivate ConsentAuthorisationApi
    ConsentAuthorisationUI --> psu : displayIdentificationScreen()
    deactivate ConsentAuthorisationUI
    psu -> ConsentAuthorisationUI ++ : updatePsuIdentification\n(psu-id@tpp,psu-id@aspsp)
    ConsentAuthorisationUI -> ConsentAuthorisationApi ++ : updatePsuIdentification\n[SessionCookie, X-XSRF-TOKEN](psu-id@tpp,psu-id@aspsp)
    ConsentAuthorisationApi -> BankingProtocolFacade ++ : updatePsuIdentification(psu-id@tpp,psu-id@aspsp)
    BankingProtocolFacade -> BankingProtocol : updatePsuIdentification(psu-id@tpp,psu-id@aspsp)
    deactivate ConsentAuthorisationUI
    deactivate ConsentAuthorisationApi
    deactivate BankingProtocolFacade
else PreAuthentication.oAuthPreStep
    BankingProtocol --> BankingProtocolFacade ++ : ThrowAuthenticatePSU
    BankingProtocolFacade --> ConsentAuthorisationApi ++ : ThrowAuthenticatePSU
    deactivate BankingProtocolFacade
    ConsentAuthorisationApi --> ConsentAuthorisationUI ++ : displayRedirectInfoPage[SessionCookie, X-XSRF-TOKEN](AuthorizeResponse)
    deactivate ConsentAuthorisationApi
    ConsentAuthorisationUI --> psu : displayRedirectInfoPage()
    deactivate ConsentAuthorisationUI
    psu -> ConsentAuthorisationUI ++ : confirmRedirect()
    ConsentAuthorisationUI -> ConsentAuthorisationApi ++ : confirmRedirect()
    return redirect302[RedirectCookie,\nOnlineBankingApi.redirectEntryPoint]\n()<Redirect-Uri, state>
    deactivate ConsentAuthorisationUI
    ConsentAuthorisationUI -> ConsentAuthorisationApi ++ : GET:Redirect-URI[UserAgentContext,\nRedirectCookie]()\n<code,state>
    ConsentAuthorisationApi -> ConsentAuthorisationApi : validateRedirectCall\n(state,RedirectCookie)
    ConsentAuthorisationApi -> BankingProtocolFacade ++ : code2Token(code)
    BankingProtocolFacade -> BankingProtocol ++ : code2Token(code)
    BankingProtocol -> OnlineBankingApi ++ : GET:code2Token[\nTppContext]()<code>
    return token
    BankingProtocol -> BankingProtocol : psu-id(token):psu-id@tpp,psu-id@aspsp
    deactivate ConsentAuthorisationApi
    deactivate BankingProtocolFacade
end
BankingProtocol -> AspspBankingApi ++ : initiateConsent[UserAgentContext,\nTppContext,psu-id@aspsp](AisConsent) 
return 200_OK(TppConsentSession,\nAspspRedirectInfo)
BankingProtocol --> BankingProtocolFacade ++ : return 200_OK(TppConsentSession,\nAspspRedirectInfo)
BankingProtocolFacade --> ConsentAuthorisationApi ++ : return 200_OK(TppConsentSession,\nAspspRedirectInfo)
ConsentAuthorisationApi -> ConsentAuthorisationApi : TppConsentSession.state():state
ConsentAuthorisationApi -> ConsentAuthorisationApi : TppConsentSession.authorizeResponse(state):AuthorizeResponse
ConsentAuthorisationApi -> ConsentAuthorisationApi : TppConsentSession.sessionCookie(state):SessionCookie
alt AuthorizeResponse.isEmbeddedFlow()
ConsentAuthorisationApi --> ConsentAuthorisationUI : displayBankLoginPage[SessionCookie](AuthorizeResponse)
else AuthorizeResponse.isRedirectFlow()
ConsentAuthorisationApi --> ConsentAuthorisationUI : displayRedirectInfoPage[SessionCookie](AuthorizeResponse)
end
@enduml
