@startuml
skinparam nodesep 20
skinparam ranksep 55
'left to right direction

actor PSU

rectangle PaymentRequest [
   Amount: 100EUR
   destination: 12345
   Bank: MyBank
]

component "Open banking gateway API" as OBA {
   component session
}

database "Open banking\ngateway database" as OBADB {
  node tppUserProfile [
    Static user profile
    ---
    Name: John
    Surname: Doe
    Billing address: Nuremberg,\nFurther strasse 59
  ]
  node bankProfile [
    Bank profile
    ---
    API rate limit: 10/day
    SCA methods: Embedded
  ]
  node bankConfiguration [
    Bank configuration (xs2a-adapter)
    ---
    API address: somehost.com
  ]
  component "Static request info" as requestInfo

  tppUserProfile --> requestInfo
  bankProfile --> requestInfo
  bankConfiguration --> requestInfo
}

component "XS2A-Adapter" as adapter
component "11. Resulting request" as resultingRequest

component "Transient request data" as transientData {
  rectangle "IP address: 1.1.1.1" as IP
}

component "TPP user info provider" as extraUserInfo {
  rectangle "GeoLocation: 56.55 lat 32.33 lng" as GEO
}


package "BPMN engine" as engine {
  component "Join knowledge about user" as knowledge
  component "Required fields for call" as requiredTemplate
  component "Check if all data\nis present for request" as askForExtraInfo
  component "More information\nrequired for request" as moreInformationNeeded
}
component "XS2A-Implementation" as xs2aImpl
component "Bank" as bank

PSU --> PaymentRequest : 1. Pay 100EUR to IBAN 12345\nusing MyBank
PaymentRequest --> session : 2. REST call
session -left-> engine : 3. Compute resulting\nrequest to XS2A
requestInfo --> knowledge : 4. Read static user\nand bank profile
transientData --> knowledge : 5. Compute transient\nrequest data
extraUserInfo --> knowledge : 6. Expand knowledge\nwith extra information
knowledge --> askForExtraInfo : 7. Resulting knowledge
requiredTemplate --> askForExtraInfo : 8. Compute required\narguments\nfor XS2A api call
askForExtraInfo --> moreInformationNeeded : 9b. Go get more data
moreInformationNeeded --> OBA : 10b. Ask TPP or PSU\nfor extra information
moreInformationNeeded --> resultingRequest : Fill with more data
askForExtraInfo --> resultingRequest : 9a. Perform call\nto XS2A API
resultingRequest --> adapter : 12. Call XS2A-adapter
adapter --> xs2aImpl : 13. Call XS2A-API
xs2aImpl --> bank : 14. Internal operation
bank --> PSU : 15. Perform SCA

@enduml